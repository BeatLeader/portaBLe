@page
@model portaBLe.Pages.DatabaseComparisonModel
@{
    ViewData["Title"] = "Database Comparison";
}

<h2>@ViewData["Title"]</h2>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Database Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Current Database (Database.db)</h6>
                            <p><strong>Players:</strong> @Model.Stats.CurrentPlayerCount</p>
                            <p><strong>Scores:</strong> @Model.Stats.CurrentScoreCount</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Comparison Database (Comparison.db)</h6>
                            <p><strong>Players:</strong> @Model.Stats.ComparisonPlayerCount</p>
                            <p><strong>Scores:</strong> @Model.Stats.ComparisonScoreCount</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6>Differences</h6>
                            <p><strong>Player Count Difference:</strong> <span class="@(Model.Stats.PlayerCountDiff >= 0 ? "text-success" : "text-danger")">@(Model.Stats.PlayerCountDiff >= 0 ? "+" : "")@Model.Stats.PlayerCountDiff</span></p>
                            <p><strong>Score Count Difference:</strong> <span class="@(Model.Stats.ScoreCountDiff >= 0 ? "text-success" : "text-danger")">@(Model.Stats.ScoreCountDiff >= 0 ? "+" : "")@Model.Stats.ScoreCountDiff</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Player Comparison</h5>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="playerId">Enter Player ID to Compare:</label>
                        <div class="input-group">
                            <input type="text" class="form-control" id="playerId" placeholder="Enter player ID" />
                            <div class="input-group-append">
                                <button class="btn btn-primary" onclick="loadPlayerComparison()">Compare</button>
                            </div>
                        </div>
                    </div>

                    <div id="playerInfo" style="display:none;" class="mt-3">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-primary text-white">
                                        <h6 class="mb-0">Current Database</h6>
                                    </div>
                                    <div class="card-body" id="currentPlayerInfo">
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="mb-0">Comparison Database</h6>
                                    </div>
                                    <div class="card-body" id="comparisonPlayerInfo">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Top 100 Players Comparison</h5>
                    <small class="text-muted">PP changes across top 100 players</small>
                </div>
                <div class="card-body">
                    <canvas id="top100ComparisonChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3" id="playerChartsRow" style="display:none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Player Scores Comparison</h5>
                    <small class="text-muted">Top 200 scores weighted PP comparison</small>
                </div>
                <div class="card-body">
                    <canvas id="playerScoresChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3" id="componentsRow" style="display:none;">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">PP Components Comparison</h5>
                    <small class="text-muted">Acc, Tech, and Pass PP changes</small>
                </div>
                <div class="card-body">
                    <canvas id="componentsComparisonChart" style="height: 400px;"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script>
        let currentPlayers = @Html.Raw(Model.CurrentJsonData);
        let comparisonPlayers = @Html.Raw(Model.ComparisonJsonData);
        let charts = {};
        let playerData = null;

        // Render top 100 comparison on load
        renderTop100Comparison();

        function renderTop100Comparison() {
            const ctx = document.getElementById('top100ComparisonChart').getContext('2d');
            
            if (charts.top100) {
                charts.top100.destroy();
            }

            // Match players by ID
            const comparisonMap = new Map(comparisonPlayers.map(p => [p.id, p]));
            const labels = [];
            const ppDiffs = [];

            currentPlayers.forEach((current, index) => {
                const comparison = comparisonMap.get(current.id);
                if (comparison) {
                    const playerName = current.name || 'Unknown';
                    labels.push(`#${index + 1} ${playerName.substring(0, 15)}`);
                    ppDiffs.push(current.pp - comparison.pp);
                }
            });

            charts.top100 = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'PP Change',
                        data: ppDiffs,
                        backgroundColor: ppDiffs.map(d => d >= 0 ? 'rgba(75, 192, 192, 0.7)' : 'rgba(255, 99, 132, 0.7)'),
                        borderColor: ppDiffs.map(d => d >= 0 ? 'rgba(75, 192, 192, 1)' : 'rgba(255, 99, 132, 1)'),
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: 'PP Difference'
                            }
                        },
                        x: {
                            ticks: {
                                maxRotation: 90,
                                minRotation: 45,
                                font: {
                                    size: 10
                                }
                            }
                        }
                    }
                }
            });
        }

        async function loadPlayerComparison() {
            const playerId = document.getElementById('playerId').value.trim();
            if (!playerId) {
                alert('Please enter a player ID');
                return;
            }

            try {
                const response = await fetch(`/DatabaseComparison?handler=PlayerComparison&playerId=${encodeURIComponent(playerId)}`);
                if (!response.ok) {
                    throw new Error('Failed to load player comparison');
                }

                playerData = await response.json();

                if (playerData.error) {
                    alert(playerData.error);
                    return;
                }

                displayPlayerInfo(playerData);
                renderPlayerScoresComparison(playerData);
                renderComponentsComparison(playerData);

                document.getElementById('playerInfo').style.display = 'block';
                document.getElementById('playerChartsRow').style.display = 'block';
                document.getElementById('componentsRow').style.display = 'block';
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading player comparison');
            }
        }

        function displayPlayerInfo(data) {
            const currentDiv = document.getElementById('currentPlayerInfo');
            const comparisonDiv = document.getElementById('comparisonPlayerInfo');

            if (data.currentPlayer) {
                currentDiv.innerHTML = `
                    <p><strong>Name:</strong> ${data.currentPlayer.name}</p>
                    <p><strong>Rank:</strong> #${data.currentPlayer.rank}</p>
                    <p><strong>Total PP:</strong> ${data.currentPlayer.pp.toFixed(2)}</p>
                    <p><strong>Acc PP:</strong> ${data.currentPlayer.accPp.toFixed(2)}</p>
                    <p><strong>Tech PP:</strong> ${data.currentPlayer.techPp.toFixed(2)}</p>
                    <p><strong>Pass PP:</strong> ${data.currentPlayer.passPp.toFixed(2)}</p>
                `;
            } else {
                currentDiv.innerHTML = '<p class="text-danger">Player not found in current database</p>';
            }

            if (data.comparisonPlayer) {
                const ppDiff = data.currentPlayer ? (data.currentPlayer.pp - data.comparisonPlayer.pp) : 0;
                comparisonDiv.innerHTML = `
                    <p><strong>Name:</strong> ${data.comparisonPlayer.name}</p>
                    <p><strong>Rank:</strong> #${data.comparisonPlayer.rank}</p>
                    <p><strong>Total PP:</strong> ${data.comparisonPlayer.pp.toFixed(2)}</p>
                    <p><strong>Acc PP:</strong> ${data.comparisonPlayer.accPp.toFixed(2)}</p>
                    <p><strong>Tech PP:</strong> ${data.comparisonPlayer.techPp.toFixed(2)}</p>
                    <p><strong>Pass PP:</strong> ${data.comparisonPlayer.passPp.toFixed(2)}</p>
                    ${data.currentPlayer ? `<hr><p><strong>PP Difference:</strong> <span class="${ppDiff >= 0 ? 'text-success' : 'text-danger'}">${ppDiff >= 0 ? '+' : ''}${ppDiff.toFixed(2)}</span></p>` : ''}
                `;
            } else {
                comparisonDiv.innerHTML = '<p class="text-danger">Player not found in comparison database</p>';
            }
        }

        function renderPlayerScoresComparison(data) {
            const ctx = document.getElementById('playerScoresChart').getContext('2d');
            
            if (charts.playerScores) {
                charts.playerScores.destroy();
            }

            const currentScores = data.currentScores.slice(0, 200).map((s, i) => s.pp * Math.pow(0.965, i));
            const comparisonScores = data.comparisonScores.slice(0, 200).map((s, i) => s.pp * Math.pow(0.965, i));
            const labels = Array.from({length: Math.max(currentScores.length, comparisonScores.length)}, (_, i) => i + 1);

            charts.playerScores = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Current DB Weighted PP',
                            data: currentScores,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Comparison DB Weighted PP',
                            data: comparisonScores,
                            borderColor: 'rgba(255, 99, 132, 1)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Weighted PP (PP Ã— 0.965^index)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Score Index'
                            }
                        }
                    }
                }
                });
        }

        function renderComponentsComparison(data) {
            const ctx = document.getElementById('componentsComparisonChart').getContext('2d');
            
            if (charts.components) {
                charts.components.destroy();
            }

            const currentAcc = data.currentScores.slice(0, 50).map(s => s.accPP);
            const currentTech = data.currentScores.slice(0, 50).map(s => s.techPP);
            const currentPass = data.currentScores.slice(0, 50).map(s => s.passPP);
            
            const comparisonAcc = data.comparisonScores.slice(0, 50).map(s => s.accPP);
            const comparisonTech = data.comparisonScores.slice(0, 50).map(s => s.techPP);
            const comparisonPass = data.comparisonScores.slice(0, 50).map(s => s.passPP);
            
            const labels = Array.from({length: 50}, (_, i) => `#${i + 1}`);

            charts.components = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Current Acc PP',
                            data: currentAcc,
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Comparison Acc PP',
                            data: comparisonAcc,
                            borderColor: 'rgba(54, 162, 235, 0.5)',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Current Tech PP',
                            data: currentTech,
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Comparison Tech PP',
                            data: comparisonTech,
                            borderColor: 'rgba(255, 206, 86, 0.5)',
                            borderWidth: 2,
                            pointRadius: 0
                        },
                        {
                            label: 'Current Pass PP',
                            data: currentPass,
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            borderDash: [5, 5]
                        },
                        {
                            label: 'Comparison Pass PP',
                            data: comparisonPass,
                            borderColor: 'rgba(75, 192, 192, 0.5)',
                            borderWidth: 2,
                            pointRadius: 0
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'PP'
                            }
                        }
                    }
                }
            });
        }
    </script>
}
