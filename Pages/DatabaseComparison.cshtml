@page
@model portaBLe.Pages.DatabaseComparisonModel
@{
    ViewData["Title"] = "Database Comparison";
}

<h2>@ViewData["Title"]</h2>

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Database Selection</h5>
                </div>
                <div class="card-body">
                    <form method="get" id="dbSelectionForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="mainDb">Main Database:</label>
                                    <select class="form-control" id="mainDb" name="mainDb" onchange="document.getElementById('dbSelectionForm').submit();">
                                        @foreach (var db in Model.AvailableDatabases)
                                        {
                                            <option value="@db.FileName" selected="@(db.FileName == Model.SelectedMainDb)">
                                                @db.Name - @db.FileName
                                            </option>
                                        }
                                    </select>
                                    @if (Model.AvailableDatabases.Any(db => db.FileName == Model.SelectedMainDb && !string.IsNullOrEmpty(db.Description)))
                                    {
                                        var mainDbConfig = Model.AvailableDatabases.First(db => db.FileName == Model.SelectedMainDb);
                                        <small class="form-text text-muted">@mainDbConfig.Description</small>
                                    }
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="comparisonDb">Comparison Database:</label>
                                    <select class="form-control" id="comparisonDb" name="comparisonDb" onchange="document.getElementById('dbSelectionForm').submit();">
                                        @foreach (var db in Model.AvailableDatabases)
                                        {
                                            <option value="@db.FileName" selected="@(db.FileName == Model.SelectedComparisonDb)">
                                                @db.Name - @db.FileName
                                            </option>
                                        }
                                    </select>
                                    @if (Model.AvailableDatabases.Any(db => db.FileName == Model.SelectedComparisonDb && !string.IsNullOrEmpty(db.Description)))
                                    {
                                        var compDbConfig = Model.AvailableDatabases.First(db => db.FileName == Model.SelectedComparisonDb);
                                        <small class="form-text text-muted">@compDbConfig.Description</small>
                                    }
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Database Statistics</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Main Database (@Model.SelectedMainDb)</h6>
                            <p><strong>Players:</strong> @Model.Stats.CurrentPlayerCount</p>
                            <p><strong>Scores:</strong> @Model.Stats.CurrentScoreCount</p>
                        </div>
                        <div class="col-md-6">
                            <h6>Comparison Database (@Model.SelectedComparisonDb)</h6>
                            <p><strong>Players:</strong> @Model.Stats.ComparisonPlayerCount</p>
                            <p><strong>Scores:</strong> @Model.Stats.ComparisonScoreCount</p>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <h6>Differences</h6>
                            <p><strong>Player Count Difference:</strong> <span class="@(Model.Stats.PlayerCountDiff >= 0 ? "text-success" : "text-danger")">@(Model.Stats.PlayerCountDiff >= 0 ? "+" : "")@Model.Stats.PlayerCountDiff</span></p>
                            <p><strong>Score Count Difference:</strong> <span class="@(Model.Stats.ScoreCountDiff >= 0 ? "text-success" : "text-danger")">@(Model.Stats.ScoreCountDiff >= 0 ? "+" : "")@Model.Stats.ScoreCountDiff</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-3">
        <div class="col-md-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Comparison View</h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label>Select View:</label>
                            <div class="btn-group w-100" role="group">
                                <button type="button" class="btn btn-primary" id="btnPlayers" onclick="showView('players')">All Players</button>
                                <button type="button" class="btn btn-outline-primary" id="btnMaps" onclick="showView('maps')">All Maps</button>
                            </div>
                        </div>
                        <div class="col-md-4" id="rankLimitContainer">
                            <label for="rankLimit">Rank Limit (Players Only):</label>
                            <input type="number" class="form-control" id="rankLimit" value="1000" min="1" max="100000" onchange="loadPlayersData()">
                        </div>
                        <div class="col-md-4">
                            <label for="searchBox">Search:</label>
                            <input type="text" class="form-control" id="searchBox" placeholder="Search by name..." onkeyup="filterTable()">
                        </div>
                    </div>

                    <div class="mb-2">
                        <button class="btn btn-success" onclick="exportToCSV()">
                            <i class="bi bi-download"></i> Export to CSV
                        </button>
                        <span id="recordCount" class="ms-3 text-muted"></span>
                    </div>

                    <div id="loadingIndicator" class="text-center my-4" style="display: none;">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Loading data...</p>
                    </div>

                    <div id="playersView" class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                        <table class="table table-striped table-hover" id="playersTable">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th onclick="sortTable('players', 'comparisonRank')" style="cursor: pointer;">Name <span id="sort-comparisonRank"></span></th>
                                    <th onclick="sortTable('players', 'rankDiff')" style="cursor: pointer;">Rank Diff <span id="sort-rankDiff"></span></th>
                                    <th onclick="sortTable('players', 'ppDiff')" style="cursor: pointer;">PP Diff <span id="sort-ppDiff"></span></th>
                                    <th onclick="sortTable('players', 'accPpDiff')" style="cursor: pointer;">AccPP Diff <span id="sort-accPpDiff"></span></th>
                                    <th onclick="sortTable('players', 'techPpDiff')" style="cursor: pointer;">TechPP Diff <span id="sort-techPpDiff"></span></th>
                                    <th onclick="sortTable('players', 'passPpDiff')" style="cursor: pointer;">PassPP Diff <span id="sort-passPpDiff"></span></th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody">
                            </tbody>
                        </table>
                    </div>

                    <div id="mapsView" class="table-responsive" style="max-height: 600px; overflow-y: auto; display: none;">
                        <table class="table table-striped table-hover" id="mapsTable">
                            <thead class="sticky-top bg-light">
                                <tr>
                                    <th onclick="sortTable('maps', 'name')" style="cursor: pointer;">Name <span id="sort-map-name"></span></th>
                                    <th onclick="sortTable('maps', 'starsDiff')" style="cursor: pointer;">Stars Diff <span id="sort-map-starsDiff"></span></th>
                                    <th onclick="sortTable('maps', 'accRatingDiff')" style="cursor: pointer;">Acc Rating Diff <span id="sort-map-accRatingDiff"></span></th>
                                    <th onclick="sortTable('maps', 'passRatingDiff')" style="cursor: pointer;">Pass Rating Diff <span id="sort-map-passRatingDiff"></span></th>
                                    <th onclick="sortTable('maps', 'techRatingDiff')" style="cursor: pointer;">Tech Rating Diff <span id="sort-map-techRatingDiff"></span></th>
                                    <th onclick="sortTable('maps', 'currentStars')" style="cursor: pointer;">Current Stars <span id="sort-map-currentStars"></span></th>
                                    <th onclick="sortTable('maps', 'comparisonStars')" style="cursor: pointer;">Comparison Stars <span id="sort-map-comparisonStars"></span></th>
                                </tr>
                            </thead>
                            <tbody id="mapsTableBody">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentView = 'players';
        let playersData = [];
        let mapsData = [];
        let sortColumn = null;
        let sortDirection = 'asc';
        let isFormSubmitting = false;

        function getMainDb() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('mainDb') || document.getElementById('mainDb').value;
        }

        function getComparisonDb() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('comparisonDb') || document.getElementById('comparisonDb').value;
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (!isFormSubmitting) {
                loadPlayersData();
            }
        });

        document.getElementById('dbSelectionForm').addEventListener('submit', function() {
            isFormSubmitting = true;
        });

        function showView(view) {
            currentView = view;
            sortColumn = null;
            sortDirection = 'asc';

            if (view === 'players') {
                document.getElementById('btnPlayers').className = 'btn btn-primary';
                document.getElementById('btnMaps').className = 'btn btn-outline-primary';
                document.getElementById('playersView').style.display = 'block';
                document.getElementById('mapsView').style.display = 'none';
                document.getElementById('rankLimitContainer').style.display = 'block';
                
                if (playersData.length === 0) {
                    loadPlayersData();
                } else {
                    renderPlayersTable();
                }
            } else {
                document.getElementById('btnPlayers').className = 'btn btn-outline-primary';
                document.getElementById('btnMaps').className = 'btn btn-primary';
                document.getElementById('playersView').style.display = 'none';
                document.getElementById('mapsView').style.display = 'block';
                document.getElementById('rankLimitContainer').style.display = 'none';
                
                if (mapsData.length === 0) {
                    loadMapsData();
                } else {
                    renderMapsTable();
                }
            }

            document.getElementById('searchBox').value = '';
        }

        async function loadPlayersData() {
            document.getElementById('loadingIndicator').style.display = 'block';
            const rankLimit = document.getElementById('rankLimit').value || 1000;
            const mainDb = getMainDb();
            const comparisonDb = getComparisonDb();
            try {
                const response = await fetch(`/DatabaseComparison?handler=AllPlayersComparison&mainDb=${encodeURIComponent(mainDb)}&comparisonDb=${encodeURIComponent(comparisonDb)}&rankLimit=${rankLimit}`);
                if (!response.ok) throw new Error('Failed to load players data');
                
                playersData = await response.json();
                renderPlayersTable();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading players data');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        async function loadMapsData() {
            document.getElementById('loadingIndicator').style.display = 'block';
            const mainDb = getMainDb();
            const comparisonDb = getComparisonDb();
            try {
                const response = await fetch(`/DatabaseComparison?handler=AllMapsComparison&mainDb=${encodeURIComponent(mainDb)}&comparisonDb=${encodeURIComponent(comparisonDb)}`);
                if (!response.ok) throw new Error('Failed to load maps data');
                
                mapsData = await response.json();
                renderMapsTable();
            } catch (error) {
                console.error('Error:', error);
                alert('Error loading maps data');
            } finally {
                document.getElementById('loadingIndicator').style.display = 'none';
            }
        }

        function renderPlayersTable() {
            const tbody = document.getElementById('playersTableBody');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            let filteredData = playersData;

            if (searchTerm) {
                filteredData = playersData.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            filteredData.forEach(player => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td><a href="/player/${player.id}" class="text-decoration-none">${player.name}</a></td>
                    <td class="${player.rankDiff < 0 ? 'text-danger' : player.rankDiff > 0 ? 'text-success' : ''}">${player.rankDiff > 0 ? '+' : ''}${player.rankDiff}</td>
                    <td class="${player.ppDiff > 0 ? 'text-success' : player.ppDiff < 0 ? 'text-danger' : ''}">${player.ppDiff > 0 ? '+' : ''}${player.ppDiff.toFixed(2)}</td>
                    <td class="${player.accPpDiff > 0 ? 'text-success' : player.accPpDiff < 0 ? 'text-danger' : ''}">${player.accPpDiff > 0 ? '+' : ''}${player.accPpDiff.toFixed(2)}</td>
                    <td class="${player.techPpDiff > 0 ? 'text-success' : player.techPpDiff < 0 ? 'text-danger' : ''}">${player.techPpDiff > 0 ? '+' : ''}${player.techPpDiff.toFixed(2)}</td>
                    <td class="${player.passPpDiff > 0 ? 'text-success' : player.passPpDiff < 0 ? 'text-danger' : ''}">${player.passPpDiff > 0 ? '+' : ''}${player.passPpDiff.toFixed(2)}</td>
                `;
            });

            updateRecordCount(filteredData.length, playersData.length);
        }

        function renderMapsTable() {
            const tbody = document.getElementById('mapsTableBody');
            tbody.innerHTML = '';

            const searchTerm = document.getElementById('searchBox').value.toLowerCase();
            let filteredData = mapsData;

            if (searchTerm) {
                filteredData = mapsData.filter(m => m.name.toLowerCase().includes(searchTerm));
            }

            filteredData.forEach(map => {
                const row = tbody.insertRow();
                const modeDisplay = map.modeName ? ` (${map.modeName}` : '';
                const diffDisplay = map.difficultyName ? (modeDisplay ? ` - ${map.difficultyName})` : ` (${map.difficultyName})`) : (modeDisplay ? ')' : '');
                row.innerHTML = `
                    <td><a href="/leaderboard/${map.id}" class="text-decoration-none">${map.name}${modeDisplay}${diffDisplay}</a></td>
                    <td class="${map.starsDiff > 0 ? 'text-success' : map.starsDiff < 0 ? 'text-danger' : ''}">${map.starsDiff > 0 ? '+' : ''}${map.starsDiff.toFixed(2)}</td>
                    <td class="${map.accRatingDiff > 0 ? 'text-success' : map.accRatingDiff < 0 ? 'text-danger' : ''}">${map.accRatingDiff > 0 ? '+' : ''}${map.accRatingDiff.toFixed(2)}</td>
                    <td class="${map.passRatingDiff > 0 ? 'text-success' : map.passRatingDiff < 0 ? 'text-danger' : ''}">${map.passRatingDiff > 0 ? '+' : ''}${map.passRatingDiff.toFixed(2)}</td>
                    <td class="${map.techRatingDiff > 0 ? 'text-success' : map.techRatingDiff < 0 ? 'text-danger' : ''}">${map.techRatingDiff > 0 ? '+' : ''}${map.techRatingDiff.toFixed(2)}</td>
                    <td>${map.currentStars.toFixed(2)}</td>
                    <td>${map.comparisonStars.toFixed(2)}</td>
                `;
            });

            updateRecordCount(filteredData.length, mapsData.length);
        }

        function updateRecordCount(filtered, total) {
            const countElement = document.getElementById('recordCount');
            if (filtered === total) {
                countElement.textContent = `Showing ${total} records`;
            } else {
                countElement.textContent = `Showing ${filtered} of ${total} records`;
            }
        }

        function filterTable() {
            if (currentView === 'players') {
                renderPlayersTable();
            } else {
                renderMapsTable();
            }
        }

        function sortTable(view, column) {
            if (sortColumn === column) {
                sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                sortColumn = column;
                sortDirection = 'asc';
            }

            clearSortIndicators(view);
            
            const indicator = sortDirection === 'asc' ? '▲' : '▼';
            const elementId = view === 'players' ? `sort-${column}` : `sort-map-${column}`;
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = indicator;
            }

            if (view === 'players') {
                playersData.sort((a, b) => {
                    let valA = a[column];
                    let valB = b[column];
                    
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    
                    if (sortDirection === 'asc') {
                        return valA < valB ? -1 : valA > valB ? 1 : 0;
                    } else {
                        return valA > valB ? -1 : valA < valB ? 1 : 0;
                    }
                });
                renderPlayersTable();
            } else {
                const columnMap = {
                    'name': 'name',
                    'starsDiff': 'starsDiff',
                    'accRatingDiff': 'accRatingDiff',
                    'passRatingDiff': 'passRatingDiff',
                    'techRatingDiff': 'techRatingDiff',
                    'currentStars': 'currentStars',
                    'comparisonStars': 'comparisonStars'
                };
                
                const actualColumn = columnMap[column] || column;
                
                mapsData.sort((a, b) => {
                    let valA = a[actualColumn];
                    let valB = b[actualColumn];
                    
                    if (typeof valA === 'string') {
                        valA = valA.toLowerCase();
                        valB = valB.toLowerCase();
                    }
                    
                    if (sortDirection === 'asc') {
                        return valA < valB ? -1 : valA > valB ? 1 : 0;
                    } else {
                        return valA > valB ? -1 : valA < valB ? 1 : 0;
                    }
                });
                renderMapsTable();
            }
        }

        function clearSortIndicators(view) {
            if (view === 'players') {
                ['comparisonRank', 'rankDiff', 'ppDiff', 'accPpDiff', 'techPpDiff', 'passPpDiff'].forEach(col => {
                    const element = document.getElementById(`sort-${col}`);
                    if (element) element.textContent = '';
                });
            } else {
                ['name', 'starsDiff', 'accRatingDiff', 'passRatingDiff', 'techRatingDiff', 'currentStars', 'comparisonStars'].forEach(col => {
                    const element = document.getElementById(`sort-map-${col}`);
                    if (element) element.textContent = '';
                });
            }
        }

        function exportToCSV() {
            const mainDb = getMainDb();
            const comparisonDb = getComparisonDb();
            if (currentView === 'players') {
                const url = `/DatabaseComparison?handler=ExportPlayersCsv&mainDb=${encodeURIComponent(mainDb)}&comparisonDb=${encodeURIComponent(comparisonDb)}`;
                window.location.href = url;
            } else {
                const url = `/DatabaseComparison?handler=ExportMapsCsv&mainDb=${encodeURIComponent(mainDb)}&comparisonDb=${encodeURIComponent(comparisonDb)}`;
                window.location.href = url;
            }
        }
    </script>

    <style>
        .sticky-top {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
}
